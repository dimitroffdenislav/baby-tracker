<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–Ω–µ–≤–µ–Ω —Ä–µ–∂–∏–º –Ω–∞ –±–µ–±–µ—Ç–æ</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f1f2f6; }
    h1 { text-align: center; }
    form, table, .summary { background: white; padding: 1rem; border-radius: 10px; margin-bottom: 2rem; }
    input, textarea { width: 100%; margin-top: 0.5rem; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
    label { display: block; margin-top: 1rem; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; background: #0984e3; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5rem; border: 1px solid #ddd; text-align: center; }
    .summary { font-weight: bold; }
    #loginSection { background: white; padding: 2rem; border-radius: 10px; max-width: 400px; margin: auto; margin-top: 4rem; }
  </style>
</head>
<body>
  <h1>–î–Ω–µ–≤–µ–Ω —Ä–µ–∂–∏–º –Ω–∞ –±–µ–±–µ—Ç–æ</h1>

  <div id="loginSection">
    <h2>–í—Ö–æ–¥</h2>
    <input type="email" id="email" placeholder="–ò–º–µ–π–ª" value="" required />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª–∞" value="" required />
    <label>
      <input type="checkbox" id="rememberMe" /> –ó–∞–ø–æ–º–Ω–∏ –º–µ
    </label>
    <button id="loginBtn">–í—Ö–æ–¥</button>
  </div>

  <div id="appSection" style="display: none;">
    <form id="entryForm">
      <label>–î–∞—Ç–∞: <input type="date" name="date" required></label>
      <label>–ß–∞—Å: <input type="time" name="time" required></label>
      <label>–ê–¥–∞–ø—Ç–∏—Ä–∞–Ω–æ –º–ª—è–∫–æ (–º–ª): <input type="number" name="formula" id="formulaInput"></label>
      <label>–ö—ä—Ä–º–∞ (–º–ª): <input type="number" name="breastmilk" id="breastmilkInput"></label>
      <label><input type="checkbox" name="poo"> –ê–∫–∞–ª</label>
      <label><input type="checkbox" name="pee"> –ü–∏—à–∞–ª</label>
      <label><input type="checkbox" id="breastfeeding" name="breastfeeding" onchange="toggleBreastfeeding()"> –ö—ä—Ä–º–µ–Ω–µ</label>
      <div id="breastfeedingTime" style="display: none;">
        <label>–í—Ä–µ–º–µ –Ω–∞ –∫—ä—Ä–º–µ–Ω–µ (–º–∏–Ω): <input type="number" name="breastfeedingTime"></label>
      </div>
      <label>–ó–∞–±–µ–ª–µ–∂–∫–∏: <textarea name="notes"></textarea></label>
      <button type="submit">–î–æ–±–∞–≤–∏ –∑–∞–ø–∏—Å</button>
    </form>

    <table id="dataTable">
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th><th>–ß–∞—Å</th><th>–ê–¥–∞–ø—Ç–∏—Ä–∞–Ω–æ –º–ª—è–∫–æ</th><th>–ö—ä—Ä–º–∞</th>
          <th>–ê–∫–∞–ª</th><th>–ü–∏—à–∞–ª</th><th>–ö—ä—Ä–º–µ–Ω–µ (–º–∏–Ω)</th><th>–ó–∞–±–µ–ª–µ–∂–∫–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="summary" id="summary"></div>
    <button onclick="logout()">–ò–∑—Ö–æ–¥</button>
  </div>

<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    orderBy,
    deleteDoc,
    doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    setPersistence,
    browserLocalPersistence,
    browserSessionPersistence,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgeoFmRG4PWgB4qNtp6u_AVLyoqD5m8CE",
    authDomain: "baby-tracker-fab40.firebaseapp.com",
    projectId: "baby-tracker-fab40",
    storageBucket: "baby-tracker-fab40.appspot.com",
    messagingSenderId: "60430088674",
    appId: "1:60430088674:web:4eaff3297a1411e70b21bb",
    measurementId: "G-3EESV4H39C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let userId = null;

  const form = document.getElementById("entryForm");
  const tableBody = document.querySelector("#dataTable tbody");
  const summary = document.getElementById("summary");
  const dateInput = document.querySelector('input[name="date"]');
  const loginSection = document.getElementById("loginSection");
  const appSection = document.getElementById("appSection");

  function setTodayDate() {
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
  }

  // üîê Login
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const rememberMe = document.getElementById("rememberMe").checked;

    const persistence = rememberMe
      ? browserLocalPersistence
      : browserSessionPersistence;

    try {
      await setPersistence(auth, persistence);
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      if (error.code === "auth/user-not-found") {
        try {
          await createUserWithEmailAndPassword(auth, email, password);
        } catch (signupErr) {
          alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: " + signupErr.message);
        }
      } else {
        alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥: " + error.message);
      }
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      loginSection.style.display = "none";
      appSection.style.display = "block";
      setTodayDate();
      renderTable();
    } else {
      loginSection.style.display = "block";
      appSection.style.display = "none";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!userId) return alert("–ù—è–º–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª.");
    const formData = new FormData(form);
    const entry = {
      date: formData.get("date"),
      time: formData.get("time"),
      formula: Number(formData.get("formula") || 0),
      breastmilk: Number(formData.get("breastmilk") || 0),
      poo: formData.get("poo") ? "–î–∞" : "–ù–µ",
      pee: formData.get("pee") ? "–î–∞" : "–ù–µ",
      breastfeeding: formData.get("breastfeeding") ? "–î–∞" : "–ù–µ",
      breastfeedingTime: formData.get("breastfeedingTime") || "",
      notes: formData.get("notes"),
      timestamp: serverTimestamp(),
    };

    const ref = collection(db, "babyData", userId, "entries");
    await addDoc(ref, entry);
    form.reset();
    document.getElementById("breastfeedingTime").style.display = "none";
    setTodayDate();
    renderTable();
  });

  async function renderTable() {
    if (!userId) return;
    tableBody.innerHTML = "";
    const currentDate = dateInput.value;
    const ref = collection(db, "babyData", userId, "entries");
    const q = query(ref, where("date", "==", currentDate), orderBy("timestamp"));
    const snapshot = await getDocs(q);

    let totalFormula = 0,
      totalBreastmilk = 0,
      countPoo = 0,
      countPee = 0,
      countBreastfeeding = 0;

    snapshot.forEach((docSnap) => {
      const entry = docSnap.data();
      totalFormula += entry.formula || 0;
      totalBreastmilk += entry.breastmilk || 0;
      if (entry.poo === "–î–∞") countPoo++;
      if (entry.pee === "–î–∞") countPee++;
      if (entry.breastfeeding === "–î–∞") countBreastfeeding++;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.date}</td><td>${entry.time}</td>
        <td>${entry.formula}</td><td>${entry.breastmilk}</td>
        <td>${entry.poo}</td><td>${entry.pee}</td>
        <td>${entry.breastfeedingTime}</td><td>${entry.notes}</td>
        <td><button onclick="deleteEntry('${docSnap.id}')">–ò–∑—Ç—Ä–∏–π</button></td>
      `;
      tableBody.appendChild(row);
    });

    summary.innerHTML = `
      –û–±—â–æ –∞–¥–∞–ø—Ç–∏—Ä–∞–Ω–æ –º–ª—è–∫–æ: <strong>${totalFormula} –º–ª</strong><br>
      –û–±—â–æ –∫—ä—Ä–º–∞: <strong>${totalBreastmilk} –º–ª</strong><br>
      –ê–∫–∞–ª: <strong>${countPoo}</strong> | –ü–∏—à–∞–ª: <strong>${countPee}</strong><br>
      –ö—ä—Ä–º–µ–Ω–∏—è: <strong>${countBreastfeeding}</strong>
    `;
  }

  window.deleteEntry = async function (id) {
    if (!userId) return;
    const ref = doc(db, "babyData", userId, "entries", id);
    await deleteDoc(ref);
    renderTable();
  };

  dateInput.addEventListener("change", renderTable);
  window.toggleBreastfeeding = () => {
    const checkBox = document.getElementById("breastfeeding");
    document.getElementById("breastfeedingTime").style.display = checkBox.checked
      ? "block"
      : "none";
  };
</script>

</body>
</html>
