<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Дневен режим на бебето</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f1f2f6;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .auth {
      max-width: 400px;
      margin: 0 auto 2rem;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .auth__title {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
    }
    .auth__field {
      margin-bottom: 1rem;
    }
    .auth__input {
      width: 100%;
      padding: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .auth__checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .auth__checkbox input {
      margin-right: 0.5rem;
    }
    .auth__button {
      width: 100%;
      background: #0984e3;
      color: white;
      padding: 0.5rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .form {
      background: white;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 10px;
    }
    .form__group {
      margin-bottom: 1rem;
    }
    .form__input, .form__textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table__header,
    .table__cell {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    .table__header {
      background: #f1f2f6;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .table__cell[data-label]:before {
        content: attr(data-label) ": ";
        font-weight: bold;
        display: block;
      }
      .table__header {
        display: none;
      }
      .table__cell {
        display: block;
        text-align: left;
        border: none;
        border-bottom: 1px solid #ddd;
      }
      .table__row {
        display: block;
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="auth" id="authSection">
      <h1 class="auth__title">Вход</h1>
      <div class="auth__field">
        <input type="email" id="email" placeholder="Имейл" class="auth__input" />
      </div>
      <div class="auth__field">
        <input type="password" id="password" placeholder="Парола" class="auth__input" />
      </div>
      <div class="auth__checkbox">
        <input type="checkbox" id="rememberMe" />
        <label for="rememberMe">Запомни ме</label>
      </div>
      <button id="loginBtn" class="auth__button">Вход</button>
    </div>

    <div id="appSection" style="display:none;">
      <form id="entryForm" class="form">
        <div class="form__group">
          <label>Дата:<br><input type="date" name="date" required class="form__input" /></label>
        </div>
        <div class="form__group">
          <label>Час:<br><input type="time" name="time" required class="form__input" /></label>
        </div>
        <div class="form__group">
          <label>Адаптирано мляко (мл):<br><input type="number" name="formula" class="form__input" /></label>
        </div>
        <div class="form__group">
          <label>Кърма (мл):<br><input type="number" name="breastmilk" class="form__input" /></label>
        </div>
        <div class="form__group">
          <label><input type="checkbox" name="poo" /> Акал</label>
          <label><input type="checkbox" name="pee" /> Пишал</label>
          <label><input type="checkbox" id="breastfeeding" name="breastfeeding" /> Кърмене</label>
          <div id="breastfeedingTimeContainer" style="display: none;">
            <label>Време на кърмене (мин):<br><input type="number" name="breastfeedingTime" class="form__input" /></label>
          </div>
        </div>
        <div class="form__group">
          <label>Забележки:<br><textarea name="notes" class="form__textarea"></textarea></label>
        </div>
        <button type="submit" class="auth__button">Добави</button>
        <button id="logoutBtn" class="auth__button" style="background:#d63031; margin-top:1rem">Изход</button>
      </form>

      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr class="table__row">
              <th class="table__header">Дата</th>
              <th class="table__header">Час</th>
              <th class="table__header">Адаптирано</th>
              <th class="table__header">Кърма</th>
              <th class="table__header">Акал</th>
              <th class="table__header">Пишал</th>
              <th class="table__header">Кърмене (мин)</th>
              <th class="table__header">Забележки</th>
              <th class="table__header">Действия</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query,
      where, orderBy, deleteDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      onAuthStateChanged, setPersistence, browserLocalPersistence,
      browserSessionPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const config = {
      apiKey: "AIzaSyBgeoFmRG4PWgB4qNtp6u_AVLyoqD5m8CE",
      authDomain: "baby-tracker-fab40.firebaseapp.com",
      projectId: "baby-tracker-fab40",
      storageBucket: "baby-tracker-fab40.appspot.com",
      messagingSenderId: "60430088674",
      appId: "1:60430088674:web:4eaff3297a1411e70b21bb"
    };

    const app = initializeApp(config);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const form = document.getElementById("entryForm");
    const tableBody = document.getElementById("dataTable");
    const dateInput = form.querySelector("input[name='date']");

    function setTodayDate() {
      const today = new Date().toISOString().split("T")[0];
      dateInput.value = today;
    }

    function renderUI(user) {
      if (user) {
        authSection.style.display = "none";
        appSection.style.display = "block";
        setTodayDate();
        renderTable(user.uid);
      } else {
        authSection.style.display = "block";
        appSection.style.display = "none";
      }
    }

    async function renderTable(userId) {
      tableBody.innerHTML = "";
      const currentDate = dateInput.value;
      const ref = collection(db, "babyData", userId, "entries");
      const q = query(ref, where("date", "==", currentDate), orderBy("timestamp"));
      const snapshot = await getDocs(q);

      snapshot.forEach(docSnap => {
        const e = docSnap.data();
        const row = document.createElement("tr");
        row.className = "table__row";
        row.innerHTML = `
          <td class="table__cell" data-label="Дата">${e.date}</td>
          <td class="table__cell" data-label="Час">${e.time}</td>
          <td class="table__cell" data-label="Адаптирано">${e.formula}</td>
          <td class="table__cell" data-label="Кърма">${e.breastmilk}</td>
          <td class="table__cell" data-label="Акал">${e.poo}</td>
          <td class="table__cell" data-label="Пишал">${e.pee}</td>
          <td class="table__cell" data-label="Кърмене (мин)">${e.breastfeedingTime}</td>
          <td class="table__cell" data-label="Забележки">${e.notes}</td>
          <td class="table__cell" data-label="Действия">
            <button onclick="deleteEntry('${docSnap.id}')">Изтрий</button>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    window.deleteEntry = async function(id) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = doc(db, "babyData", user.uid, "entries", id);
      await deleteDoc(ref);
      renderTable(user.uid);
    };

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const rememberMe = document.getElementById("rememberMe").checked;
      const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
      await setPersistence(auth, persistence);

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        if (error.code === "auth/user-not-found") {
          await createUserWithEmailAndPassword(auth, email, password);
        } else {
          alert("Грешка при вход: " + error.message);
        }
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });

    form.breastfeeding.addEventListener("change", () => {
      document.getElementById("breastfeedingTimeContainer").style.display =
        form.breastfeeding.checked ? "block" : "none";
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("Не си логнат.");
      const fd = new FormData(form);
      const entry = {
        date: fd.get("date"),
        time: fd.get("time"),
        formula: Number(fd.get("formula") || 0),
        breastmilk: Number(fd.get("breastmilk") || 0),
        poo: fd.get("poo") ? "Да" : "Не",
        pee: fd.get("pee") ? "Да" : "Не",
        breastfeeding: fd.get("breastfeeding") ? "Да" : "Не",
        breastfeedingTime: fd.get("breastfeedingTime") || "",
        notes: fd.get("notes"),
        timestamp: serverTimestamp()
      };
      const ref = collection(db, "babyData", user.uid, "entries");
      await addDoc(ref, entry);
      form.reset();
      setTodayDate();
      renderTable(user.uid);
    });

    dateInput.addEventListener("change", () => {
      const user = auth.currentUser;
      if (user) renderTable(user.uid);
    });

    onAuthStateChanged(auth, (user) => renderUI(user));
  </script>
</body>
</html>
